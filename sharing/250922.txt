// /wwwroot/js/main.js  (rollback + 경로/메서드 안전 매핑판)

// ── Imports (경로/이름 변경 흡수용: namespace import 후 안전 별칭 매핑) ──
import { initTabs } from "./sidebar/init-tabs.js";
import { initTree } from "./sidebar/init-tree.js";
import * as Panel2 from "./sidebar/task-wbs/panel2.js";
import { initViewer, loadModel } from "./viewer/init-viewer.js";
// import { initToolbar } from "./viewer/toolbar.js";
import * as Panel2Buttons from "./sidebar/task-wbs/panel2-buttons.js";
import * as WbsLoader from "./sidebar/task-wbs/wbs/loader.js";
import * as Panel2Resizer from "./sidebar/task-wbs/layout/panel-resizer.js";
import * as Panel2Helpers from "./sidebar/task-wbs/panel2-ui-helpers.js";

// ── 메서드 이름 안전 별칭(실제 export 이름이 달라도 흡수) ──
const initPanel2Content =
  Panel2.initPanel2Content || Panel2.initPanel2 || Panel2.default;

const initTaskListButtons =
  Panel2Buttons.initTaskListButtons || Panel2Buttons.initButtons || Panel2Buttons.default;

const setSavedTaskData =
  Panel2Buttons.setSavedTaskData || Panel2Buttons.setTaskData || (() => {});

const buildWbsTreeData =
  WbsLoader.buildWbsTreeData || WbsLoader.buildWbsTree || WbsLoader.default;

const bindPanel2Resizer =
  Panel2Resizer.bindPanel2Resizer || Panel2Resizer.bindResizer || Panel2Resizer.default;

const updateWBSHighlight =
  Panel2Helpers.updateWBSHighlight || Panel2Helpers.refreshWBSHighlight || (() => {});

const disableViewerEscReset =
  Panel2Helpers.disableViewerEscReset || Panel2Helpers.disableEscReset || (() => {});

// ===== Viewer 준비 상태 대기 유틸 =====
function onceViewer(viewer, type) {
  return new Promise((resolve) => {
    const h = () => { viewer.removeEventListener(type, h); resolve(); };
    viewer.addEventListener(type, h);
  });
}
function hasObjectTree(viewer) {
  return !!(viewer.model?.getData?.()?.instanceTree);
}
async function waitObjectTree(viewer) {
  if (hasObjectTree(viewer)) return;
  await onceViewer(viewer, Autodesk.Viewing.OBJECT_TREE_CREATED_EVENT);
}
async function waitGeometry(viewer) {
  const got = new Promise((r) =>
    viewer.addEventListener(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, () => r(), { once: true })
  );
  await Promise.race([got, new Promise((r) => setTimeout(r, 800))]);
}
function waitIdle(timeout = 60) {
  return new Promise((resolve) => {
    if (typeof window.requestIdleCallback === 'function') {
      window.requestIdleCallback(() => resolve(), { timeout });
    } else {
      setTimeout(resolve, timeout);
    }
  });
}
async function waitViewerReady(viewer) {
  await waitObjectTree(viewer);
  await waitGeometry(viewer);
  await waitIdle(60);
}

// 전면 하이라이트 게이트: 초기엔 OFF
window.__ALLOW_WBS_UPDATE = false;

// --- Repaint Gantt on window resize (throttled) ---
window.addEventListener('resize', _.throttle(() => {
  try {
    if (window.gantt && window.taskTree) {
      window.gantt.renderFromTrees(window.taskTree, window.wbsTree);
    }
  } catch (e) {
    console.warn('[gantt] resize redraw failed', e);
  }
}, 200));

const login = document.getElementById("login");
let taskData = []; // 현재 모델의 Task 데이터 (트리용)

// 샘플 데이터 (서버에 데이터 없을 때 사용)
const SAMPLE_TASK_DATA = [
  {
    no: "1",
    selectOptions: ["시공", "가설", "철거"],
    selectedOption: "시공",
    title: "Task A",
    start: "2024-06-25",
    end: "2024-07-01",
    linkedObjects: [{ urn: "SAMPLE_URN", dbId: 1001, text: "벽체1" }],
    children: [
      {
        no: "1.1",
        selectOptions: ["시공", "가설", "철거"],
        selectedOption: "시공",
        title: "Subtask A1",
        start: "2024-06-26",
        end: "2024-06-30",
        linkedObjects: [{ urn: "SAMPLE_URN", dbId: 1002, text: "벽체2" }]
      }
    ],
  },
  { no: "2", selectOptions: ["시공", "가설", "철거"], selectedOption: "시공", title: "Task B", start: "", end: "", linkedObjects: [] },
];

// URN을 특수문자 없는 safe key로 변환
function safeUrn(urn) {
  return urn.replace(/[^a-zA-Z0-9]/g, "_");
}

// taskData의 모든 linkedObjects에 urn 채워넣기
function fillUrnRecursive(task, defaultUrn) {
  if (Array.isArray(task.linkedObjects)) {
    task.linkedObjects.forEach(obj => { if (!obj.urn) obj.urn = defaultUrn || window.CURRENT_MODEL_URN; });
  }
  if (Array.isArray(task.children)) {
    task.children.forEach(child => fillUrnRecursive(child, defaultUrn));
  }
}

// -------- 앱 전체 초기화 IIFE ---------
(async function () {
  try {
    // 1. 로그인 상태 확인
    const resp = await fetch("/api/auth/profile", { credentials: "include" });
    if (!resp.ok) {
      window.location.replace("/api/auth/login");
      return;
    }
    const user = await resp.json();
    login.innerText = `Logout (${user.name})`;
    login.onclick = () => {
      const iframe = document.createElement("iframe");
      iframe.style.visibility = "hidden";
      iframe.src = "https://accounts.autodesk.com/Authentication/LogOut";
      document.body.appendChild(iframe);
      iframe.onload = () => {
        window.location.replace("/api/auth/logout");
        document.body.removeChild(iframe);
      };
    };

    // 2. 기본 레이아웃 표시
    const Sidebar = document.getElementById("sidebar");
    const Header = document.getElementById("header");
    const Preview = document.getElementById("preview");
    const sidebarResizer = document.getElementById("sidebar-resizer");
    const Loading = document.getElementById("loading");

    Sidebar.style.display = "";
    Sidebar.style.width = "500px";
    sidebarResizer.style.display = "";
    sidebarResizer.style.left = "500px";
    Preview.style.display = "";
    Preview.style.left = Sidebar.style.width;
    Preview.style.right = "0";
    Preview.style.top = "3em";
    Preview.style.bottom = "0";
    Header.style.display = "";
    Loading.style.display = "none";
    login.style.visibility = "visible";

    // 3. 뷰어/탭 초기화
    initTabs("#sidebar");
    const viewer = await initViewer(document.getElementById("viewer-host"));
    disableViewerEscReset(viewer);
    // initToolbar(viewer);

    // 4. 프로젝트 트리 초기화: 모델 선택 시 콜백
    initTree("#tree", async (versionId) => {
      destroyTaskPanel();

      const urn = window.btoa(versionId).replace(/=/g, "");
      window.CURRENT_MODEL_URN = urn;
      window.CURRENT_MODEL_SAFE_URN = safeUrn(urn);

      taskData.length = 0;
      setSavedTaskData([]);
      await loadTaskDataIfExists();
      taskData.forEach((t) => fillUrnRecursive(t, urn));

      console.log("[main.js] 모델 선택!", versionId, urn);
      await loadModel(viewer, urn);

      // ✅ 뷰어 로딩 완료 + idle 보장
      await waitViewerReady(viewer);

      // 이제 WBS 생성
      let wbsData = [];
      try { wbsData = await buildWbsTreeData(viewer); }
      catch (e) { console.warn("[main.js] WBS 데이터 생성 실패!", e); wbsData = []; }

      initTaskListButtons();
      initPanel2Content(taskData, wbsData);
      bindPanel2Resizer();

      window.dispatchEvent(new Event("panel2-ready"));

      // 간트 1회 렌더(부하 적게)
      requestAnimationFrame(() => {
        try { window.gantt?.renderFromTrees(window.taskTree, window.wbsTree); } catch (_) {}
      });

      // 🔶 초기 하이라이트: DOM 안정화 후 1회만
      await waitIdle(60);
      if (window.taskTree && window.wbsTree) {
        try { window.taskTree.render(true, true); } catch{}
        window.__ALLOW_WBS_UPDATE = true;
        try { updateWBSHighlight(); } catch(e) { console.warn('[wbs] first HL failed', e); }
      }
    });

  } catch (err) {
    alert("Could not initialize the application. See console for more details.");
    console.error(err);
  }
})();

// ----- Task 데이터 (서버 or 샘플) 불러오는 함수 -----
async function loadTaskDataIfExists() {
  try {
    const safeUrnVal = window.CURRENT_MODEL_SAFE_URN;
    const url = `/api/tasks?urn=${safeUrnVal}`;
    const resp = await fetch(url, { credentials: "include" });
    if (resp.ok) {
      const data = await resp.json();
      taskData.length = 0;
      if (Array.isArray(data) && data.length > 0) {
        data.forEach((item) => taskData.push(item));
        setSavedTaskData(taskData);
      } else {
        SAMPLE_TASK_DATA.forEach((item) => taskData.push(structuredClone(item)));
        setSavedTaskData(taskData);
      }
    } else {
      taskData.length = 0;
      SAMPLE_TASK_DATA.forEach((item) => taskData.push(structuredClone(item)));
      setSavedTaskData(taskData);
    }
  } catch (err) {
    taskData.length = 0;
    SAMPLE_TASK_DATA.forEach((item) => taskData.push(structuredClone(item)));
    setSavedTaskData(taskData);
    console.warn("task 데이터를 불러오지 못했습니다. 샘플로 초기화:", err);
  }
}

// ----- Task/WBS 패널 전체 제거 및 DOM 재생성 -----
function destroyTaskPanel() {
  console.log("[destroy] panel2 destroy & 재생성");
  try { $.ui.fancytree.getTree("#treegrid")?.destroy(); } catch (e) {}
  window.taskTree = null;
  window.wbsTree = null;
  try { window.gantt?.drawFromRows?.([]); } catch(_) {}

  $("#wbs-group-content").empty();
  $("#panel2").html(`
    <div id="vertical-split-container">
      <div id="task-list-panel">
        <div class="panel-header">
          <span class="title">Task List</span>
          <div class="button-group">
            <button id="btn-add">추가</button>
            <button id="btn-delete">삭제</button>
            <button id="btn-select">객체 선택</button>
            <button id="btn-link">데이터 연결</button>
            <button id="btn-unlink">연결 해제</button>
            <button id="btn-date">공정현황</button>
            <button id="btn-test">테스트</button>
            <button id="btn-update">저장</button>
          </div>
        </div>
        <table id="treegrid" style="width: 100%" class="fancytree-ext-table">
          <colgroup>
            <col width="40px" />
            <col width="60px" />
            <col width="260px" />
            <col width="100px" />
            <col width="100px" />
            <col width="100px" />
            <col width="60px" />
          </colgroup>
          <thead>
            <tr>
              <th>No.</th>
              <th>구분</th>
              <th>작업명</th>
              <th>시작일</th>
              <th>소요시간(Day)</th>
              <th>완료일</th>
              <th>객체개수</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="resizer"></div>
      <div class="sidebar-panel" id="wbs-group-list-panel">
        <div class="panel-header">
          <span class="title">WBS Group List</span>
        </div>
        <div class="panel-content" id="wbs-group-content">
          <div id="wbs-tree"></div>
        </div>
      </div>
    </div>
  `);
}