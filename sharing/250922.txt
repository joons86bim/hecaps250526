// /wwwroot/js/main.js  (rollback + ê²½ë¡œ/ë©”ì„œë“œ ì•ˆì „ ë§¤í•‘íŒ)

// â”€â”€ Imports (ê²½ë¡œ/ì´ë¦„ ë³€ê²½ í¡ìˆ˜ìš©: namespace import í›„ ì•ˆì „ ë³„ì¹­ ë§¤í•‘) â”€â”€
import { initTabs } from "./sidebar/init-tabs.js";
import { initTree } from "./sidebar/init-tree.js";
import * as Panel2 from "./sidebar/task-wbs/panel2.js";
import { initViewer, loadModel } from "./viewer/init-viewer.js";
// import { initToolbar } from "./viewer/toolbar.js";
import * as Panel2Buttons from "./sidebar/task-wbs/panel2-buttons.js";
import * as WbsLoader from "./sidebar/task-wbs/wbs/loader.js";
import * as Panel2Resizer from "./sidebar/task-wbs/layout/panel-resizer.js";
import * as Panel2Helpers from "./sidebar/task-wbs/panel2-ui-helpers.js";

// â”€â”€ ë©”ì„œë“œ ì´ë¦„ ì•ˆì „ ë³„ì¹­(ì‹¤ì œ export ì´ë¦„ì´ ë‹¬ë¼ë„ í¡ìˆ˜) â”€â”€
const initPanel2Content =
  Panel2.initPanel2Content || Panel2.initPanel2 || Panel2.default;

const initTaskListButtons =
  Panel2Buttons.initTaskListButtons || Panel2Buttons.initButtons || Panel2Buttons.default;

const setSavedTaskData =
  Panel2Buttons.setSavedTaskData || Panel2Buttons.setTaskData || (() => {});

const buildWbsTreeData =
  WbsLoader.buildWbsTreeData || WbsLoader.buildWbsTree || WbsLoader.default;

const bindPanel2Resizer =
  Panel2Resizer.bindPanel2Resizer || Panel2Resizer.bindResizer || Panel2Resizer.default;

const updateWBSHighlight =
  Panel2Helpers.updateWBSHighlight || Panel2Helpers.refreshWBSHighlight || (() => {});

const disableViewerEscReset =
  Panel2Helpers.disableViewerEscReset || Panel2Helpers.disableEscReset || (() => {});

// ===== Viewer ì¤€ë¹„ ìƒíƒœ ëŒ€ê¸° ìœ í‹¸ =====
function onceViewer(viewer, type) {
  return new Promise((resolve) => {
    const h = () => { viewer.removeEventListener(type, h); resolve(); };
    viewer.addEventListener(type, h);
  });
}
function hasObjectTree(viewer) {
  return !!(viewer.model?.getData?.()?.instanceTree);
}
async function waitObjectTree(viewer) {
  if (hasObjectTree(viewer)) return;
  await onceViewer(viewer, Autodesk.Viewing.OBJECT_TREE_CREATED_EVENT);
}
async function waitGeometry(viewer) {
  const got = new Promise((r) =>
    viewer.addEventListener(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, () => r(), { once: true })
  );
  await Promise.race([got, new Promise((r) => setTimeout(r, 800))]);
}
function waitIdle(timeout = 60) {
  return new Promise((resolve) => {
    if (typeof window.requestIdleCallback === 'function') {
      window.requestIdleCallback(() => resolve(), { timeout });
    } else {
      setTimeout(resolve, timeout);
    }
  });
}
async function waitViewerReady(viewer) {
  await waitObjectTree(viewer);
  await waitGeometry(viewer);
  await waitIdle(60);
}

// ì „ë©´ í•˜ì´ë¼ì´íŠ¸ ê²Œì´íŠ¸: ì´ˆê¸°ì—” OFF
window.__ALLOW_WBS_UPDATE = false;

// --- Repaint Gantt on window resize (throttled) ---
window.addEventListener('resize', _.throttle(() => {
  try {
    if (window.gantt && window.taskTree) {
      window.gantt.renderFromTrees(window.taskTree, window.wbsTree);
    }
  } catch (e) {
    console.warn('[gantt] resize redraw failed', e);
  }
}, 200));

const login = document.getElementById("login");
let taskData = []; // í˜„ì¬ ëª¨ë¸ì˜ Task ë°ì´í„° (íŠ¸ë¦¬ìš©)

// ìƒ˜í”Œ ë°ì´í„° (ì„œë²„ì— ë°ì´í„° ì—†ì„ ë•Œ ì‚¬ìš©)
const SAMPLE_TASK_DATA = [
  {
    no: "1",
    selectOptions: ["ì‹œê³µ", "ê°€ì„¤", "ì² ê±°"],
    selectedOption: "ì‹œê³µ",
    title: "Task A",
    start: "2024-06-25",
    end: "2024-07-01",
    linkedObjects: [{ urn: "SAMPLE_URN", dbId: 1001, text: "ë²½ì²´1" }],
    children: [
      {
        no: "1.1",
        selectOptions: ["ì‹œê³µ", "ê°€ì„¤", "ì² ê±°"],
        selectedOption: "ì‹œê³µ",
        title: "Subtask A1",
        start: "2024-06-26",
        end: "2024-06-30",
        linkedObjects: [{ urn: "SAMPLE_URN", dbId: 1002, text: "ë²½ì²´2" }]
      }
    ],
  },
  { no: "2", selectOptions: ["ì‹œê³µ", "ê°€ì„¤", "ì² ê±°"], selectedOption: "ì‹œê³µ", title: "Task B", start: "", end: "", linkedObjects: [] },
];

// URNì„ íŠ¹ìˆ˜ë¬¸ì ì—†ëŠ” safe keyë¡œ ë³€í™˜
function safeUrn(urn) {
  return urn.replace(/[^a-zA-Z0-9]/g, "_");
}

// taskDataì˜ ëª¨ë“  linkedObjectsì— urn ì±„ì›Œë„£ê¸°
function fillUrnRecursive(task, defaultUrn) {
  if (Array.isArray(task.linkedObjects)) {
    task.linkedObjects.forEach(obj => { if (!obj.urn) obj.urn = defaultUrn || window.CURRENT_MODEL_URN; });
  }
  if (Array.isArray(task.children)) {
    task.children.forEach(child => fillUrnRecursive(child, defaultUrn));
  }
}

// -------- ì•± ì „ì²´ ì´ˆê¸°í™” IIFE ---------
(async function () {
  try {
    // 1. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    const resp = await fetch("/api/auth/profile", { credentials: "include" });
    if (!resp.ok) {
      window.location.replace("/api/auth/login");
      return;
    }
    const user = await resp.json();
    login.innerText = `Logout (${user.name})`;
    login.onclick = () => {
      const iframe = document.createElement("iframe");
      iframe.style.visibility = "hidden";
      iframe.src = "https://accounts.autodesk.com/Authentication/LogOut";
      document.body.appendChild(iframe);
      iframe.onload = () => {
        window.location.replace("/api/auth/logout");
        document.body.removeChild(iframe);
      };
    };

    // 2. ê¸°ë³¸ ë ˆì´ì•„ì›ƒ í‘œì‹œ
    const Sidebar = document.getElementById("sidebar");
    const Header = document.getElementById("header");
    const Preview = document.getElementById("preview");
    const sidebarResizer = document.getElementById("sidebar-resizer");
    const Loading = document.getElementById("loading");

    Sidebar.style.display = "";
    Sidebar.style.width = "500px";
    sidebarResizer.style.display = "";
    sidebarResizer.style.left = "500px";
    Preview.style.display = "";
    Preview.style.left = Sidebar.style.width;
    Preview.style.right = "0";
    Preview.style.top = "3em";
    Preview.style.bottom = "0";
    Header.style.display = "";
    Loading.style.display = "none";
    login.style.visibility = "visible";

    // 3. ë·°ì–´/íƒ­ ì´ˆê¸°í™”
    initTabs("#sidebar");
    const viewer = await initViewer(document.getElementById("viewer-host"));
    disableViewerEscReset(viewer);
    // initToolbar(viewer);

    // 4. í”„ë¡œì íŠ¸ íŠ¸ë¦¬ ì´ˆê¸°í™”: ëª¨ë¸ ì„ íƒ ì‹œ ì½œë°±
    initTree("#tree", async (versionId) => {
      destroyTaskPanel();

      const urn = window.btoa(versionId).replace(/=/g, "");
      window.CURRENT_MODEL_URN = urn;
      window.CURRENT_MODEL_SAFE_URN = safeUrn(urn);

      taskData.length = 0;
      setSavedTaskData([]);
      await loadTaskDataIfExists();
      taskData.forEach((t) => fillUrnRecursive(t, urn));

      console.log("[main.js] ëª¨ë¸ ì„ íƒ!", versionId, urn);
      await loadModel(viewer, urn);

      // âœ… ë·°ì–´ ë¡œë”© ì™„ë£Œ + idle ë³´ì¥
      await waitViewerReady(viewer);

      // ì´ì œ WBS ìƒì„±
      let wbsData = [];
      try { wbsData = await buildWbsTreeData(viewer); }
      catch (e) { console.warn("[main.js] WBS ë°ì´í„° ìƒì„± ì‹¤íŒ¨!", e); wbsData = []; }

      initTaskListButtons();
      initPanel2Content(taskData, wbsData);
      bindPanel2Resizer();

      window.dispatchEvent(new Event("panel2-ready"));

      // ê°„íŠ¸ 1íšŒ ë Œë”(ë¶€í•˜ ì ê²Œ)
      requestAnimationFrame(() => {
        try { window.gantt?.renderFromTrees(window.taskTree, window.wbsTree); } catch (_) {}
      });

      // ğŸ”¶ ì´ˆê¸° í•˜ì´ë¼ì´íŠ¸: DOM ì•ˆì •í™” í›„ 1íšŒë§Œ
      await waitIdle(60);
      if (window.taskTree && window.wbsTree) {
        try { window.taskTree.render(true, true); } catch{}
        window.__ALLOW_WBS_UPDATE = true;
        try { updateWBSHighlight(); } catch(e) { console.warn('[wbs] first HL failed', e); }
      }
    });

  } catch (err) {
    alert("Could not initialize the application. See console for more details.");
    console.error(err);
  }
})();

// ----- Task ë°ì´í„° (ì„œë²„ or ìƒ˜í”Œ) ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ -----
async function loadTaskDataIfExists() {
  try {
    const safeUrnVal = window.CURRENT_MODEL_SAFE_URN;
    const url = `/api/tasks?urn=${safeUrnVal}`;
    const resp = await fetch(url, { credentials: "include" });
    if (resp.ok) {
      const data = await resp.json();
      taskData.length = 0;
      if (Array.isArray(data) && data.length > 0) {
        data.forEach((item) => taskData.push(item));
        setSavedTaskData(taskData);
      } else {
        SAMPLE_TASK_DATA.forEach((item) => taskData.push(structuredClone(item)));
        setSavedTaskData(taskData);
      }
    } else {
      taskData.length = 0;
      SAMPLE_TASK_DATA.forEach((item) => taskData.push(structuredClone(item)));
      setSavedTaskData(taskData);
    }
  } catch (err) {
    taskData.length = 0;
    SAMPLE_TASK_DATA.forEach((item) => taskData.push(structuredClone(item)));
    setSavedTaskData(taskData);
    console.warn("task ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒ˜í”Œë¡œ ì´ˆê¸°í™”:", err);
  }
}

// ----- Task/WBS íŒ¨ë„ ì „ì²´ ì œê±° ë° DOM ì¬ìƒì„± -----
function destroyTaskPanel() {
  console.log("[destroy] panel2 destroy & ì¬ìƒì„±");
  try { $.ui.fancytree.getTree("#treegrid")?.destroy(); } catch (e) {}
  window.taskTree = null;
  window.wbsTree = null;
  try { window.gantt?.drawFromRows?.([]); } catch(_) {}

  $("#wbs-group-content").empty();
  $("#panel2").html(`
    <div id="vertical-split-container">
      <div id="task-list-panel">
        <div class="panel-header">
          <span class="title">Task List</span>
          <div class="button-group">
            <button id="btn-add">ì¶”ê°€</button>
            <button id="btn-delete">ì‚­ì œ</button>
            <button id="btn-select">ê°ì²´ ì„ íƒ</button>
            <button id="btn-link">ë°ì´í„° ì—°ê²°</button>
            <button id="btn-unlink">ì—°ê²° í•´ì œ</button>
            <button id="btn-date">ê³µì •í˜„í™©</button>
            <button id="btn-test">í…ŒìŠ¤íŠ¸</button>
            <button id="btn-update">ì €ì¥</button>
          </div>
        </div>
        <table id="treegrid" style="width: 100%" class="fancytree-ext-table">
          <colgroup>
            <col width="40px" />
            <col width="60px" />
            <col width="260px" />
            <col width="100px" />
            <col width="100px" />
            <col width="100px" />
            <col width="60px" />
          </colgroup>
          <thead>
            <tr>
              <th>No.</th>
              <th>êµ¬ë¶„</th>
              <th>ì‘ì—…ëª…</th>
              <th>ì‹œì‘ì¼</th>
              <th>ì†Œìš”ì‹œê°„(Day)</th>
              <th>ì™„ë£Œì¼</th>
              <th>ê°ì²´ê°œìˆ˜</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="resizer"></div>
      <div class="sidebar-panel" id="wbs-group-list-panel">
        <div class="panel-header">
          <span class="title">WBS Group List</span>
        </div>
        <div class="panel-content" id="wbs-group-content">
          <div id="wbs-tree"></div>
        </div>
      </div>
    </div>
  `);
}